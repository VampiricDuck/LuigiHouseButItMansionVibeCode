<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Minesweeper - Dev</title>
  <style>
    body{background:#071018;color:#e6f7f4;font-family:system-ui,Segoe UI,Arial;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
    #board{display:grid;grid-gap:4px;background:transparent}
    .cell{width:28px;height:28px;background:#0b1a22;border-radius:4px;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .cell.revealed{background:#1b2b33}
    .cell.mine{background:#662222}
    .controls{position:fixed;top:16px;left:16px}
  </style>
</head>
<body>
  <div class="controls"><button id="reset">Reset</button></div>
  <div id="board"></div>
  <script>
    // tiny minesweeper (8x8, 8 mines)
    const size = 8, mines = 8;
    let board = [];
    const el = document.getElementById('board');
    el.style.gridTemplateColumns = `repeat(${size},28px)`;

    function make(){
      board = Array(size*size).fill(0).map(()=>({mine:false,rev:false,flag:false,adj:0}));
      // place mines
      let placed=0;
      while(placed<mines){
        const idx=Math.floor(Math.random()*board.length);
        if(!board[idx].mine){board[idx].mine=true;placed++}
      }
      // compute adj
      for(let r=0;r<size;r++)for(let c=0;c<size;c++){
        const i=r*size+c;
        if(board[i].mine) continue;
        let a=0;
        for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++){
          const nr=r+dr,nc=c+dc;
          if(nr<0||nr>=size||nc<0||nc>=size) continue;
          if(board[nr*size+nc].mine) a++;
        }
        board[i].adj=a;
      }
      render();
    }
    function render(){
      el.innerHTML='';
      board.forEach((cell,i)=>{
        const d=document.createElement('div');
        d.className='cell'+(cell.rev?' revealed':'')+(cell.mine&&cell.rev?' mine':'');
        // show flag if present, otherwise show number when revealed
        if(cell.flag && !cell.rev) { d.textContent = 'âš‘'; d.classList.add('flagged'); }
        else d.textContent = cell.rev && !cell.mine && cell.adj>0 ? cell.adj : '';

        d.addEventListener('click',()=>reveal(i));
        d.addEventListener('contextmenu',(e)=>{
          e.preventDefault();
          // only allow toggling flag on unrevealed cells
          if(cell.rev) return;
          cell.flag = !cell.flag;
          render();
        });
        el.appendChild(d);
      });
    }
    function reveal(i){
      const cell = board[i];
      // If the cell is already revealed and is a number, attempt chord reveal
      if(cell.rev){
        if(cell.adj <= 0) return; // nothing to do for zeros or mines
        // count flagged neighbors
        const r = Math.floor(i/size), c = i % size;
        let flagged = 0;
        const neighbors = [];
        for(let dr=-1; dr<=1; dr++) for(let dc=-1; dc<=1; dc++){
          const nr = r+dr, nc = c+dc;
          if(nr<0||nr>=size||nc<0||nc>=size) continue;
          const idx = nr*size+nc;
          neighbors.push(idx);
          if(board[idx].flag) flagged++;
        }
        if(flagged !== cell.adj) return; // do nothing unless flags match the number
        // reveal all non-flagged neighbors
        for(const idx of neighbors){
          if(board[idx].flag) continue;
        // reveal neighbor - if it's a mine, trigger boom
          if(board[idx].mine){ postResult({result:'lose'}); revealAll(); return; }
          if(!board[idx].rev) reveal(idx);
        }
        render();
        checkWin();
        return;
      }

      // normal reveal on unrevealed cell
      if(cell.rev || cell.flag) return;
      cell.rev = true;
  if(cell.mine){ postResult({result:'lose'}); revealAll(); return; }
      if(cell.adj === 0){
        const r = Math.floor(i/size), c = i%size;
        for(let dr=-1; dr<=1; dr++) for(let dc=-1; dc<=1; dc++){
          const nr = r+dr, nc = c+dc;
          if(nr<0||nr>=size||nc<0||nc>=size) continue;
          reveal(nr*size+nc);
        }
      }
      render();
      checkWin();
    }
    function revealAll(){board.forEach(b=>b.rev=true);render();}
    function postResult(obj){
      const params = new URLSearchParams(location.search);
      if(params.get('embedded')==='1'){
        try{ parent.postMessage(Object.assign({minigame:'minesweeper'}, obj), '*'); }catch(e){}
      } else {
        if(obj && obj.result==='win') alert('You win!');
        if(obj && obj.result==='lose') alert('Boom!');
      }
    }
    function checkWin(){if(board.every(b=>b.rev||b.mine)) postResult({result:'win'});}
    document.getElementById('reset').addEventListener('click',make);
    make();
  </script>
</body>
</html>